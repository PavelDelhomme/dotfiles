# Nouvelle fonction pour effectuer un scan de vulnÃ©rabilitÃ©s avec Nmap
# DESC: Effectue un scan de vulnÃ©rabilitÃ©s avec Nmap en utilisant les scripts NSE pour identifier les failles de sÃ©curitÃ©. Utilise les cibles configurÃ©es si aucune n'est fournie.
# USAGE: nmap_vuln_scan [target] [options]
# EXAMPLE: nmap_vuln_scan 192.168.1.1
# EXAMPLE: nmap_vuln_scan  # Utilise les cibles configurÃ©es
function nmap_vuln_scan() {
    # VÃ©rifier et installer nmap si nÃ©cessaire
    UTILS_DIR="$HOME/dotfiles/zsh/functions/utils"
    if [ -f "$UTILS_DIR/ensure_tool.sh" ]; then
        source "$UTILS_DIR/ensure_tool.sh"
        ensure_tool nmap || return 1
    fi
    
    # Charger le gestionnaire de cibles
    local CYBER_DIR="$HOME/dotfiles/zsh/functions/cyber"
    if [ -f "$CYBER_DIR/target_manager.sh" ]; then
        source "$CYBER_DIR/target_manager.sh"
    fi
    
    local target=""
    local nmap_args=""
    
    # Parser les arguments
    if [ $# -gt 0 ]; then
        # Si le premier argument ne commence pas par -, c'est probablement la cible
        if [[ ! "$1" =~ ^- ]]; then
            target="$1"
            shift
            nmap_args="$@"
        else
            nmap_args="$@"
        fi
    fi
    
    # Si aucune cible fournie, utiliser les cibles configurÃ©es
    if [ -z "$target" ]; then
        if has_targets; then
            echo "ğŸ¯ Utilisation des cibles configurÃ©es:"
            show_targets
            echo ""
            printf "Utiliser toutes les cibles? (O/n): "
            read -r use_all
            if [ "$use_all" != "n" ] && [ "$use_all" != "N" ]; then
                # Utiliser toutes les cibles
                for t in "${CYBER_TARGETS[@]}"; do
                    echo ""
                    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                    echo "ğŸ¯ Scan de vulnÃ©rabilitÃ©s: $t"
                    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                    nmap -sV --script vuln $nmap_args "$t"
                done
                return 0
            else
                target=$(prompt_target)
                if [ -z "$target" ]; then
                    return 1
                fi
            fi
        else
            target=$(prompt_target)
            if [ -z "$target" ]; then
                return 1
            fi
        fi
    fi
    
    # Scan avec les arguments par dÃ©faut si aucun n'est fourni
    if [ -z "$nmap_args" ]; then
        nmap -sV --script vuln "$target"
    else
        nmap -sV --script vuln $nmap_args "$target"
    fi
}
