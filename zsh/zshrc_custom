# ~/dotfiles/zsh/zshrc_custom - VERSION R√âORGANIS√âE

# Restaurer le PATH original si n√©cessaire
if [ -n "$PATH_ORIGINAL" ]; then
	export PATH=$PATH_ORIGINAL
fi

DOTFILES_PATH="$HOME/dotfiles/"
DOTFILES_ZSH_PATH="$DOTFILES_PATH/zsh/"
ENV_FILE="$DOTFILES_ZSH_PATH/env.sh"
ALIASES_FILES="$DOTFILES_ZSH_PATH/aliases.zsh"
FUNCTIONS_DIR="$DOTFILES_ZSH_PATH/functions/"

# Couleurs pour messages
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# =============================================================================
# √âTAPE 1 : CHARGEMENT DES GESTIONNAIRES (*MAN) EN PREMIER
# IMPORTANT: Ces gestionnaires doivent √™tre charg√©s AVANT env.sh
# car env.sh utilise add_to_path() qui est d√©finie dans pathman.zsh
# =============================================================================
echo -e "${CYAN}üöÄ √âTAPE 1/4 : Chargement des gestionnaires...${NC}"

[ -f "$DOTFILES_ZSH_PATH/functions/pathman.zsh" ] && source "$DOTFILES_ZSH_PATH/functions/pathman.zsh" && echo -e "${GREEN}  ‚úîÔ∏è PATHMAN charg√©${NC}" || echo -e "${YELLOW}  ‚ö†Ô∏è PATHMAN introuvable${NC}"
[ -f "$DOTFILES_ZSH_PATH/functions/netman.zsh" ] && source "$DOTFILES_ZSH_PATH/functions/netman.zsh" && echo -e "${GREEN}  ‚úîÔ∏è NETMAN charg√©${NC}" || echo -e "${YELLOW}  ‚ö†Ô∏è NETMAN introuvable${NC}"
[ -f "$DOTFILES_ZSH_PATH/functions/aliaman.zsh" ] && source "$DOTFILES_ZSH_PATH/functions/aliaman.zsh" && echo -e "${GREEN}  ‚úîÔ∏è ALIAMAN charg√©${NC}" || echo -e "${YELLOW}  ‚ö†Ô∏è ALIAMAN introuvable${NC}"
[ -f "$DOTFILES_ZSH_PATH/functions/miscman.zsh" ] && source "$DOTFILES_ZSH_PATH/functions/miscman.zsh" && echo -e "${GREEN}  ‚úîÔ∏è MISCMAN charg√©${NC}" || echo -e "${YELLOW}  ‚ö†Ô∏è MISCMAN introuvable${NC}"
[ -f "$DOTFILES_ZSH_PATH/functions/searchman.zsh" ] && source "$DOTFILES_ZSH_PATH/functions/searchman.zsh" && echo -e "${GREEN}  ‚úîÔ∏è SEARCHMAN charg√©${NC}" || echo -e "${YELLOW}  ‚ö†Ô∏è SEARCHMAN introuvable${NC}"
[ -f "$DOTFILES_ZSH_PATH/functions/cyberman.zsh" ] && source "$DOTFILES_ZSH_PATH/functions/cyberman.zsh" && echo -e "${GREEN}  ‚úîÔ∏è CYBERMAN charg√©${NC}" || echo -e "${YELLOW}  ‚ö†Ô∏è CYBERMAN introuvable${NC}"
[ -f "$DOTFILES_ZSH_PATH/functions/manman.zsh" ] && source "$DOTFILES_ZSH_PATH/functions/manman.zsh" && echo -e "${GREEN}  ‚úîÔ∏è MANMAN charg√©${NC}" || echo -e "${YELLOW}  ‚ö†Ô∏è MANMAN introuvable${NC}"

# =============================================================================
# √âTAPE 2 : CHARGEMENT DES VARIABLES D'ENVIRONNEMENT
# IMPORTANT: env.sh doit √™tre charg√© APR√àS les gestionnaires car il utilise
# add_to_path() d√©finie dans pathman.zsh pour ajouter des chemins au PATH
# =============================================================================
echo -e "${CYAN}üì¶ √âTAPE 2/4 : Chargement des variables d'environnement...${NC}"
if [ -f "$ENV_FILE" ]; then
    source "$ENV_FILE"
    echo -e "${GREEN}  ‚úîÔ∏è Variables d'environnement charg√©es${NC}"
else
    echo -e "${YELLOW}  ‚ö†Ô∏è Fichier $ENV_FILE introuvable${NC}"
fi

# =============================================================================
# √âTAPE 3 : CHARGEMENT DES FONCTIONS INDIVIDUELLES
# Charge toutes les fonctions depuis les sous-dossiers organis√©s :
# - cyber/ (r√©organis√© en reconnaissance/, scanning/, vulnerability/, attacks/, analysis/, privacy/)
# - dev/, git/, misc/, network/, utils/
# =============================================================================
echo -e "${CYAN}üîß √âTAPE 3/4 : Chargement des fonctions individuelles...${NC}"

# Charger update_system.sh en premier pour remplacer les alias update/upgrade
# Supprimer les alias s'ils existent avant de charger la fonction
if [ -f "$FUNCTIONS_DIR/misc/system/update_system.sh" ]; then
    unalias update 2>/dev/null || true
    unalias upgrade 2>/dev/null || true
    source "$FUNCTIONS_DIR/misc/system/update_system.sh" 2>/dev/null && echo -e "${GREEN}  ‚úîÔ∏è update_system charg√©${NC}" || echo -e "${YELLOW}  ‚ö†Ô∏è update_system introuvable${NC}"
fi

if [ -d "$FUNCTIONS_DIR" ]; then
    local loaded_count=0
    local error_count=0
    # Charger r√©cursivement tous les scripts .sh et .zsh
    for func_file in "$FUNCTIONS_DIR"/**/*.sh "$FUNCTIONS_DIR"/**/*.zsh; do
        # Ignore les gestionnaires d√©j√† charg√©s, les backups, les sous-dossiers de cyber, alias_utils, et update_system (d√©j√† charg√©)
        if [[ "$func_file" != *"man.zsh" ]] && \
           [[ "$func_file" != *"backup"* ]] && \
           [[ "$func_file" != *"/cyber/"*.zsh ]] && \
           [[ "$func_file" != *"alias_utils.zsh" ]] && \
           [[ "$func_file" != *"update_system.sh" ]] && \
           [ -f "$func_file" ]; then
            if source "$func_file" 2>/dev/null; then
                ((loaded_count++))
            else
                ((error_count++))
                echo -e "${YELLOW}  ‚ö†Ô∏è Erreur: $(basename "$func_file")${NC}" >&2
            fi
        fi
    done
    echo -e "${GREEN}  ‚úîÔ∏è $loaded_count fonctions charg√©es${NC}"
    [ $error_count -gt 0 ] && echo -e "${YELLOW}  ‚ö†Ô∏è $error_count erreurs${NC}"
else
    echo -e "${YELLOW}  ‚ö†Ô∏è R√©pertoire de fonctions introuvable : $FUNCTIONS_DIR${NC}"
fi

# =============================================================================
# √âTAPE 4 : CHARGEMENT DES UTILITAIRES (alias, logs, documentation)
# =============================================================================
echo -e "${CYAN}üìù √âTAPE 4/5 : Chargement des utilitaires...${NC}"
[ -f "$DOTFILES_ZSH_PATH/functions/utils/alias_utils.zsh" ] && source "$DOTFILES_ZSH_PATH/functions/utils/alias_utils.zsh" && echo -e "${GREEN}  ‚úîÔ∏è Alias utils charg√©s${NC}" || echo -e "${YELLOW}  ‚ö†Ô∏è Alias utils introuvable${NC}"
[ -f "$DOTFILES_PATH/scripts/lib/actions_logger.sh" ] && source "$DOTFILES_PATH/scripts/lib/actions_logger.sh" && echo -e "${GREEN}  ‚úîÔ∏è Actions logger charg√©${NC}" || echo -e "${YELLOW}  ‚ö†Ô∏è Actions logger introuvable${NC}"

# =============================================================================
# √âTAPE 5 : CHARGEMENT DES ALIASES
# =============================================================================
echo -e "${CYAN}üìù √âTAPE 5/6 : Chargement des alias...${NC}"
if [ -f "$ALIASES_FILES" ]; then
    source "$ALIASES_FILES"
    echo -e "${GREEN}  ‚úîÔ∏è Alias charg√©s${NC}"
else
    echo -e "${YELLOW}  ‚ö†Ô∏è Fichier $ALIASES_FILES introuvable${NC}"
fi

# =============================================================================
# √âTAPE 6 : CORRECTION AUTOMATIQUE DU CONFLIT GHOSTSCRIPT
# =============================================================================
if [ -f "$DOTFILES_ZSH_PATH/functions/utils/fix_ghostscript_alias.sh" ]; then
    source "$DOTFILES_ZSH_PATH/functions/utils/fix_ghostscript_alias.sh" 2>/dev/null || true
fi

# =============================================================================
# FONCTION DOCUMENTATION INTERACTIVE
# =============================================================================
dotfiles_doc() {
    if [[ -f "$DOTFILES_PATH/scripts/lib/dotfiles_doc.sh" ]]; then
        bash "$DOTFILES_PATH/scripts/lib/dotfiles_doc.sh"
    else
        echo "‚ùå Script dotfiles_doc.sh non trouv√©"
    fi
}
alias ddoc='dotfiles_doc'
alias doc-dotfiles='dotfiles_doc'

# =============================================================================
# FONCTION BACKUP DOTFILES
# =============================================================================
backup_dotfiles() {
    echo "üìÅ Sauvegarde manuelle des dotfiles..."
    ~/auto_backup_dotfiles.sh
    echo "‚úÖ Sauvegarde termin√©e."
}

# =============================================================================
# FIN DU CHARGEMENT
# =============================================================================
neofetch
echo "üéâ Configuration ZSH personnalis√©e charg√©e avec succ√®s"

