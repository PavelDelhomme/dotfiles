# ~/dotfiles/zsh/zshrc_custom - VERSION RÃ‰ORGANISÃ‰E

# =============================================================================
# INSTANT PROMPT - DÃ©sactiver le warning pendant l'initialisation
# =============================================================================
# Powerlevel10k affiche un warning si on fait des echo pendant l'init
# On dÃ©finit cette variable pour Ã©viter le warning (le prompt sera un peu plus lent)
typeset -g POWERLEVEL9K_INSTANT_PROMPT=off

# Restaurer le PATH original si nÃ©cessaire
if [ -n "$PATH_ORIGINAL" ]; then
	export PATH=$PATH_ORIGINAL
fi

DOTFILES_PATH="$HOME/dotfiles/"
DOTFILES_ZSH_PATH="$DOTFILES_PATH/zsh/"
ENV_FILE="$DOTFILES_ZSH_PATH/env.sh"
ALIASES_FILES="$DOTFILES_ZSH_PATH/aliases.zsh"
FUNCTIONS_DIR="$DOTFILES_ZSH_PATH/functions/"

# =============================================================================
# CONFIGURATION NVM (Node Version Manager)
# IMPORTANT: Cette configuration doit Ãªtre placÃ©e AVANT l'activation d'Oh-My-Zsh
# pour Ã©viter les bugs d'accÃ¨s. Utilise le lazy-loading pour accÃ©lÃ©rer le dÃ©marrage.
# =============================================================================
export NVM_DIR="$HOME/.nvm"

# Lazy-loading NVM (ne charge NVM que quand on utilise node/npm/nvm/npx)
lazynvm() {
  unset -f nvm node npm npx
  export NVM_DIR="$HOME/.nvm"
  [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
}

# Wrappers pour lazy-loading
nvm() { lazynvm; nvm "$@"; }
node() { lazynvm; node "$@"; }
npm()  { lazynvm; npm  "$@"; }
npx()  { lazynvm; npx  "$@"; }

# Couleurs pour messages
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# =============================================================================
# Ã‰TAPE 1 : CHARGEMENT DU GESTIONNAIRE DE MODULES (MODULEMAN) EN PREMIER
# IMPORTANT: Moduleman doit Ãªtre chargÃ© en premier pour gÃ©rer l'activation/dÃ©sactivation
# =============================================================================
# Chercher le fichier de configuration dans plusieurs emplacements
# 1. Dans dotfiles (pour installation normale)
# 2. Dans ~/.config (pour Docker oÃ¹ dotfiles est en lecture seule)
MODULEMAN_CONFIG_FILE="$HOME/dotfiles/.config/moduleman/modules.conf"
if [ ! -f "$MODULEMAN_CONFIG_FILE" ]; then
    MODULEMAN_CONFIG_FILE="$HOME/.config/moduleman/modules.conf"
fi
if [ -f "$MODULEMAN_CONFIG_FILE" ]; then
    source "$MODULEMAN_CONFIG_FILE" 2>/dev/null || true
fi

# Charger moduleman pour gÃ©rer les modules
[ -f "$DOTFILES_ZSH_PATH/functions/moduleman.zsh" ] && source "$DOTFILES_ZSH_PATH/functions/moduleman.zsh" 2>/dev/null || true

# =============================================================================
# Ã‰TAPE 2 : CHARGEMENT DES GESTIONNAIRES (*MAN) SELON LA CONFIGURATION
# IMPORTANT: Ces gestionnaires doivent Ãªtre chargÃ©s AVANT env.sh
# car env.sh utilise add_to_path() qui est dÃ©finie dans pathman.zsh
# =============================================================================
# Messages d'initialisation dÃ©sactivÃ©s pour Ã©viter l'avertissement Powerlevel10k
# echo -e "${CYAN}ðŸš€ Ã‰TAPE 1/5 : Chargement des gestionnaires...${NC}"

# Fonction pour charger un manager si activÃ©
load_manager() {
    local manager_name="$1"
    local manager_file="$2"
    local display_name="$3"
    local var_name="MODULE_${manager_name}"
    local module_status="${(P)var_name:-enabled}"
    
    if [ "$module_status" = "enabled" ]; then
        if [ -f "$manager_file" ]; then
            source "$manager_file" >/dev/null 2>&1 || true
            # Messages dÃ©sactivÃ©s pour Ã©viter l'avertissement Powerlevel10k
            # && echo -e "${GREEN}  âœ”ï¸ $display_name chargÃ©${NC}" || echo -e "${YELLOW}  âš ï¸ $display_name introuvable${NC}"
        fi
        # else
        #     echo -e "${YELLOW}  âš ï¸ $display_name introuvable${NC}"
    fi
    # else
    #     echo -e "${YELLOW}  âš ï¸ $display_name dÃ©sactivÃ© (moduleman)${NC}"
}

load_manager "pathman" "$DOTFILES_ZSH_PATH/functions/pathman.zsh" "PATHMAN"
load_manager "netman" "$DOTFILES_ZSH_PATH/functions/netman.zsh" "NETMAN"
load_manager "aliaman" "$DOTFILES_ZSH_PATH/functions/aliaman.zsh" "ALIAMAN"
load_manager "miscman" "$DOTFILES_ZSH_PATH/functions/miscman.zsh" "MISCMAN"
load_manager "searchman" "$DOTFILES_ZSH_PATH/functions/searchman.zsh" "SEARCHMAN"
load_manager "multimediaman" "$DOTFILES_ZSH_PATH/functions/multimediaman.zsh" "MULTIMEDIAMAN"
load_manager "cyberman" "$DOTFILES_ZSH_PATH/functions/cyberman.zsh" "CYBERMAN"
# Charger cyberlearn (systÃ¨me d'apprentissage cybersÃ©curitÃ©)
load_manager "cyberlearn" "$DOTFILES_ZSH_PATH/functions/cyberlearn.zsh" "CYBERLEARN"
load_manager "devman" "$DOTFILES_ZSH_PATH/functions/devman.zsh" "DEVMAN"
load_manager "gitman" "$DOTFILES_ZSH_PATH/functions/gitman.zsh" "GITMAN"
load_manager "helpman" "$DOTFILES_ZSH_PATH/functions/helpman.zsh" "HELPMAN"
load_manager "manman" "$DOTFILES_ZSH_PATH/functions/manman.zsh" "MANMAN"
load_manager "configman" "$DOTFILES_ZSH_PATH/functions/configman.zsh" "CONFIGMAN"
load_manager "installman" "$DOTFILES_ZSH_PATH/functions/installman.zsh" "INSTALLMAN"
load_manager "moduleman" "$DOTFILES_ZSH_PATH/functions/moduleman.zsh" "MODULEMAN"
load_manager "fileman" "$DOTFILES_ZSH_PATH/functions/fileman.zsh" "FILEMAN"
load_manager "virtman" "$DOTFILES_ZSH_PATH/functions/virtman.zsh" "VIRTMAN"
load_manager "sshman" "$DOTFILES_ZSH_PATH/functions/sshman.zsh" "SSHMAN"
load_manager "testzshman" "$DOTFILES_ZSH_PATH/functions/testzshman.zsh" "TESTZSHMAN"
load_manager "testman" "$DOTFILES_ZSH_PATH/functions/testman.zsh" "TESTMAN"

# =============================================================================
# Ã‰TAPE 2.5 : CONFIGURATION HISTORIQUE (AVANT ENV)
# =============================================================================
# Charger la configuration d'historique partagÃ©
[ -f "$DOTFILES_ZSH_PATH/history.zsh" ] && source "$DOTFILES_ZSH_PATH/history.zsh" 2>/dev/null || true

# =============================================================================
# Ã‰TAPE 2 : CHARGEMENT DES VARIABLES D'ENVIRONNEMENT
# IMPORTANT: env.sh doit Ãªtre chargÃ© APRÃˆS les gestionnaires car il utilise
# add_to_path() dÃ©finie dans pathman.zsh pour ajouter des chemins au PATH
# =============================================================================
# Messages d'initialisation dÃ©sactivÃ©s pour Ã©viter l'avertissement Powerlevel10k
# echo -e "${CYAN}ðŸ“¦ Ã‰TAPE 2/5 : Chargement des variables d'environnement...${NC}"
if [ -f "$ENV_FILE" ]; then
    source "$ENV_FILE" >/dev/null 2>&1
    # Messages dÃ©sactivÃ©s pour Ã©viter l'avertissement Powerlevel10k
    # echo -e "${GREEN}  âœ”ï¸ Variables d'environnement chargÃ©es${NC}"
fi
# else
#     echo -e "${YELLOW}  âš ï¸ Fichier $ENV_FILE introuvable${NC}"

# =============================================================================
# Ã‰TAPE 3.5 : CHARGEMENT DES FONCTIONS UTILITAIRES
# =============================================================================
# Charger ipinfo (informations IP et rÃ©seau)
[ -f "$DOTFILES_ZSH_PATH/functions/ipinfo.zsh" ] && source "$DOTFILES_ZSH_PATH/functions/ipinfo.zsh" 2>/dev/null || true
# Charger network_scanner (scanner rÃ©seau en temps rÃ©el)
[ -f "$DOTFILES_ZSH_PATH/functions/network_scanner.zsh" ] && source "$DOTFILES_ZSH_PATH/functions/network_scanner.zsh" 2>/dev/null || true
# Charger whatismyip (IP publique)
[ -f "$DOTFILES_ZSH_PATH/functions/whatismyip.zsh" ] && source "$DOTFILES_ZSH_PATH/functions/whatismyip.zsh" 2>/dev/null || true

# =============================================================================
# Ã‰TAPE 4 : CHARGEMENT DES FONCTIONS INDIVIDUELLES
# Charge toutes les fonctions depuis les sous-dossiers organisÃ©s :
# - cyber/ (rÃ©organisÃ© en reconnaissance/, scanning/, vulnerability/, attacks/, analysis/, privacy/)
# - dev/, git/, misc/, network/, utils/
# =============================================================================
# Messages d'initialisation dÃ©sactivÃ©s pour Ã©viter l'avertissement Powerlevel10k
# echo -e "${CYAN}ðŸ”§ Ã‰TAPE 3/5 : Chargement des fonctions individuelles...${NC}"

# Charger update_system.sh en premier pour remplacer les alias update/upgrade
# Supprimer les alias s'ils existent avant de charger la fonction
if [ -f "$FUNCTIONS_DIR/misc/system/update_system.sh" ]; then
    unalias update 2>/dev/null || true
    unalias upgrade 2>/dev/null || true
    source "$FUNCTIONS_DIR/misc/system/update_system.sh" >/dev/null 2>&1 || true
    # Messages dÃ©sactivÃ©s pour Ã©viter l'avertissement Powerlevel10k
fi

if [ -d "$FUNCTIONS_DIR" ]; then
    local loaded_count=0
    local error_count=0
    
    # Charger installman et configman en premier (gestionnaires d'installation/configuration)
    # VÃ©rifier si activÃ©s via moduleman
    local installman_status="${MODULE_installman:-enabled}"
    local configman_status="${MODULE_configman:-enabled}"
    
    if [ "$installman_status" = "enabled" ] && [ -f "$FUNCTIONS_DIR/installman.zsh" ]; then
        source "$FUNCTIONS_DIR/installman.zsh" 2>/dev/null && ((loaded_count++)) || ((error_count++))
    # Messages dÃ©sactivÃ©s pour Ã©viter l'avertissement Powerlevel10k
    fi
    
    if [ "$configman_status" = "enabled" ] && [ -f "$FUNCTIONS_DIR/configman.zsh" ]; then
        source "$FUNCTIONS_DIR/configman.zsh" >/dev/null 2>&1 && ((loaded_count++)) || ((error_count++))
    # Messages dÃ©sactivÃ©s pour Ã©viter l'avertissement Powerlevel10k
    fi
    
    # Charger rÃ©cursivement tous les scripts .sh et .zsh
    for func_file in "$FUNCTIONS_DIR"/**/*.sh "$FUNCTIONS_DIR"/**/*.zsh; do
        # Ignore les gestionnaires dÃ©jÃ  chargÃ©s, les backups, les sous-dossiers de cyber, alias_utils, update_system, install-tool, et les scripts d'installation
        # Ignore aussi les scripts de modules configman/fileman qui sont exÃ©cutÃ©s via les managers, pas sourcÃ©s
        if [[ "$func_file" != *"man.zsh" ]] && \
           [[ "$func_file" != *"backup"* ]] && \
           [[ "$func_file" != *"/cyber/"*.zsh ]] && \
           [[ "$func_file" != *"alias_utils.zsh" ]] && \
           [[ "$func_file" != *"update_system.sh" ]] && \
           [[ "$func_file" != *"install-tool.zsh" ]] && \
           [[ "$func_file" != *"installman.zsh" ]] && \
           [[ "$func_file" != *"configman.zsh" ]] && \
           [[ "$func_file" != *"/install/"* ]] && \
           [[ "$func_file" != *"/configman/modules/"* ]] && \
           [[ "$func_file" != *"/fileman/modules/"* ]] && \
           [ -f "$func_file" ]; then
            if source "$func_file" 2>/dev/null; then
                ((loaded_count++))
            else
                ((error_count++))
                # Messages dÃ©sactivÃ©s pour Ã©viter l'avertissement Powerlevel10k
                # echo -e "${YELLOW}  âš ï¸ Erreur: $(basename "$func_file")${NC}" >&2
            fi
        fi
    done
    # Messages dÃ©sactivÃ©s pour Ã©viter l'avertissement Powerlevel10k
    # echo -e "${GREEN}  âœ”ï¸ $loaded_count fonctions chargÃ©es${NC}"
    # [ $error_count -gt 0 ] && echo -e "${YELLOW}  âš ï¸ $error_count erreurs${NC}"
fi
# Messages dÃ©sactivÃ©s pour Ã©viter l'avertissement Powerlevel10k
# else
#     echo -e "${YELLOW}  âš ï¸ RÃ©pertoire de fonctions introuvable : $FUNCTIONS_DIR${NC}"

# =============================================================================
# Ã‰TAPE 5 : CHARGEMENT DES UTILITAIRES (alias, logs, documentation)
# =============================================================================
# Messages d'initialisation dÃ©sactivÃ©s pour Ã©viter l'avertissement Powerlevel10k
# echo -e "${CYAN}ðŸ“ Ã‰TAPE 4/5 : Chargement des utilitaires...${NC}"
[ -f "$DOTFILES_ZSH_PATH/functions/utils/alias_utils.zsh" ] && source "$DOTFILES_ZSH_PATH/functions/utils/alias_utils.zsh" >/dev/null 2>&1 || true
[ -f "$DOTFILES_PATH/scripts/lib/actions_logger.sh" ] && source "$DOTFILES_PATH/scripts/lib/actions_logger.sh" >/dev/null 2>&1 || true
[ -f "$DOTFILES_ZSH_PATH/functions/helpman/modules/help_system.sh" ] && source "$DOTFILES_ZSH_PATH/functions/helpman/modules/help_system.sh" >/dev/null 2>&1 || true
# Messages dÃ©sactivÃ©s pour Ã©viter l'avertissement Powerlevel10k

# =============================================================================
# Ã‰TAPE 6 : CHARGEMENT DES ALIASES
# =============================================================================
# Messages d'initialisation dÃ©sactivÃ©s pour Ã©viter l'avertissement Powerlevel10k
# echo -e "${CYAN}ðŸ“ Ã‰TAPE 5/5 : Chargement des alias...${NC}"
if [ -f "$ALIASES_FILES" ]; then
    source "$ALIASES_FILES" >/dev/null 2>&1
    # Messages dÃ©sactivÃ©s pour Ã©viter l'avertissement Powerlevel10k
    # echo -e "${GREEN}  âœ”ï¸ Alias chargÃ©s${NC}"
fi
# Messages dÃ©sactivÃ©s pour Ã©viter l'avertissement Powerlevel10k
# else
#     echo -e "${YELLOW}  âš ï¸ Fichier $ALIASES_FILES introuvable${NC}"

# =============================================================================
# Ã‰TAPE 6 : CORRECTION AUTOMATIQUE DU CONFLIT GHOSTSCRIPT
# =============================================================================
# Messages dÃ©sactivÃ©s pour Ã©viter l'avertissement Powerlevel10k
if [ -f "$DOTFILES_ZSH_PATH/functions/utils/fix_ghostscript_alias.sh" ]; then
    source "$DOTFILES_ZSH_PATH/functions/utils/fix_ghostscript_alias.sh" >/dev/null 2>&1 || true
fi

# =============================================================================
# FONCTION DOCUMENTATION INTERACTIVE
# =============================================================================
dotfiles_doc() {
    if [[ -f "$DOTFILES_PATH/scripts/lib/dotfiles_doc.sh" ]]; then
        bash "$DOTFILES_PATH/scripts/lib/dotfiles_doc.sh"
    else
        echo "âŒ Script dotfiles_doc.sh non trouvÃ©"
    fi
}
alias ddoc='dotfiles_doc'
alias doc-dotfiles='dotfiles_doc'

# =============================================================================
# FONCTION BACKUP DOTFILES
# =============================================================================
backup_dotfiles() {
    echo "ðŸ“ Sauvegarde manuelle des dotfiles..."
    ~/auto_backup_dotfiles.sh
    echo "âœ… Sauvegarde terminÃ©e."
}

# =============================================================================
# FONCTION SSH AUTO SETUP
# =============================================================================
if [ -f "$DOTFILES_ZSH_PATH/functions/ssh_auto_setup.zsh" ]; then
    source "$DOTFILES_ZSH_PATH/functions/ssh_auto_setup.zsh" 2>/dev/null || true
fi

# =============================================================================
# PROMPT POWERLEVEL10K AVEC SUPPORT GIT
# =============================================================================
# IMPORTANT: Le prompt Manjaro charge P10k + /usr/share/zsh/p10k.zsh qui Ã©crase notre config
# Solution: Configurer GITSTATUS_DIR AVANT le chargement, puis charger notre .p10k.zsh aprÃ¨s

# Ã‰TAPE 0: Configurer GITSTATUS_DIR AVANT TOUT (critique pour que gitstatus fonctionne)
# DÃ©finir GITSTATUS_DIR si gitstatusd est installÃ© via le package zsh-theme-powerlevel10k
# C'est nÃ©cessaire pour que Powerlevel10k puisse afficher le statut Git
# IMPORTANT: Cette variable DOIT Ãªtre dÃ©finie AVANT le chargement de P10k
if [[ -z "${GITSTATUS_DIR:-}" ]] && [[ -d /usr/share/zsh-theme-powerlevel10k/gitstatus ]]; then
    export GITSTATUS_DIR=/usr/share/zsh-theme-powerlevel10k/gitstatus
    typeset -g POWERLEVEL9K_GITSTATUS_DIR=/usr/share/zsh-theme-powerlevel10k/gitstatus
    # S'assurer que la variable est persistante
    typeset -gx GITSTATUS_DIR=/usr/share/zsh-theme-powerlevel10k/gitstatus
fi

# Ã‰TAPE 0.5: Charger gitstatus plugin AVANT P10k (CRITIQUE)
# Powerlevel10k ne charge PAS automatiquement gitstatus, il faut le charger explicitement
# Sinon les variables VCS_STATUS_* ne seront jamais dÃ©finies
if [[ ! $+functions[gitstatus_start] ]] && [[ -f /usr/share/zsh-theme-powerlevel10k/gitstatus/gitstatus.plugin.zsh ]]; then
    source /usr/share/zsh-theme-powerlevel10k/gitstatus/gitstatus.plugin.zsh 2>/dev/null || true
fi

# Ã‰TAPE 0.5: Charger gitstatus plugin AVANT P10k (CRITIQUE)
# Powerlevel10k ne charge PAS automatiquement gitstatus, il faut le charger explicitement
# Sinon les variables VCS_STATUS_* ne seront jamais dÃ©finies
if [[ ! $+functions[gitstatus_start] ]] && [[ -f /usr/share/zsh-theme-powerlevel10k/gitstatus/gitstatus.plugin.zsh ]]; then
    source /usr/share/zsh-theme-powerlevel10k/gitstatus/gitstatus.plugin.zsh 2>/dev/null || true
fi

# Ã‰tape 1: Charger P10k DIRECTEMENT (sans prompt Manjaro pour Ã©viter les conflits)
# Le prompt Manjaro charge /usr/share/zsh/p10k.zsh qui a VCS_DISABLED_WORKDIR_PATTERN='~'
# et VCS_DISABLE_GITSTATUS_FORMATTING=true, ce qui empÃªche gitstatus de fonctionner
# SOLUTION: Charger P10k directement pour avoir le contrÃ´le total
if [[ -f /usr/share/zsh-theme-powerlevel10k/powerlevel10k.zsh-theme ]]; then
    # Powerlevel10k systÃ¨me (Arch/Manjaro) - chargement direct
    source /usr/share/zsh-theme-powerlevel10k/powerlevel10k.zsh-theme
elif [[ -e /usr/share/zsh/manjaro-zsh-prompt ]]; then
    # Fallback: Prompt Manjaro si P10k systÃ¨me absent
    # Mais on chargera notre config aprÃ¨s pour Ã©craser
    source /usr/share/zsh/manjaro-zsh-prompt
elif [[ -f "$HOME/.oh-my-zsh/custom/themes/powerlevel10k/powerlevel10k.zsh-theme" ]]; then
    # Powerlevel10k Oh-My-Zsh
    source "$HOME/.oh-my-zsh/custom/themes/powerlevel10k/powerlevel10k.zsh-theme"
fi

# Ã‰tape 2: CrÃ©er/verifier le symlink .p10k.zsh
if [[ -f "$DOTFILES_PATH/.p10k.zsh" ]]; then
    # Si le fichier existe dans dotfiles, crÃ©er un symlink vers ~/.p10k.zsh
    if [[ ! -L "$HOME/.p10k.zsh" ]] || [[ "$(readlink "$HOME/.p10k.zsh")" != "$DOTFILES_PATH/.p10k.zsh" ]]; then
        # CrÃ©er un backup si un fichier existe dÃ©jÃ 
        if [[ -f "$HOME/.p10k.zsh" ]] && [[ ! -L "$HOME/.p10k.zsh" ]]; then
            mv "$HOME/.p10k.zsh" "$HOME/.p10k.zsh.backup.$(date +%Y%m%d_%H%M%S)" 2>/dev/null || true
        fi
        # CrÃ©er le symlink
        ln -sf "$DOTFILES_PATH/.p10k.zsh" "$HOME/.p10k.zsh" 2>/dev/null || true
    fi
fi

# =============================================================================
# FIN DU CHARGEMENT
# =============================================================================
# Neofetch (si installÃ©) - dÃ©sactivÃ© pendant l'initialisation
# if command -v neofetch >/dev/null 2>&1; then
#     neofetch
# fi
# Messages dÃ©sactivÃ©s pour Ã©viter l'avertissement Powerlevel10k
# echo "ðŸŽ‰ Configuration ZSH personnalisÃ©e chargÃ©e avec succÃ¨s"

# =============================================================================
# Ã‰TAPE FINALE : CHARGER NOTRE CONFIG P10K EN DERNIER
# =============================================================================
# CRITIQUE : Charger notre .p10k.zsh APRÃˆS TOUT (mÃªme aprÃ¨s les messages)
# pour Ã©craser la config systÃ¨me du prompt Manjaro
# Cette Ã©tape doit Ãªtre ABSOLUMENT en dernier pour que Git s'affiche
# 
# IMPORTANT: Le prompt Manjaro charge /usr/share/zsh/p10k.zsh qui a
# POWERLEVEL9K_VCS_DISABLED_WORKDIR_PATTERN='~' (exclut le home)
# Notre config Ã©crase cela avec POWERLEVEL9K_VCS_DISABLED_WORKDIR_PATTERN=''
if [[ -f "$HOME/.p10k.zsh" ]]; then
    source "$HOME/.p10k.zsh" 2>/dev/null || true
    # Forcer le rechargement de P10k pour appliquer notre config
    # et s'assurer que gitstatus est initialisÃ©
    if (( $+functions[p10k] )); then
        p10k reload 2>/dev/null || true
        # Attendre un peu pour que gitstatus se connecte
        sleep 0.1
    fi
elif [[ -f "$DOTFILES_PATH/.p10k.zsh" ]]; then
    source "$DOTFILES_PATH/.p10k.zsh" 2>/dev/null || true
    # Forcer le rechargement de P10k pour appliquer notre config
    if (( $+functions[p10k] )); then
        p10k reload 2>/dev/null || true
        # Attendre un peu pour que gitstatus se connecte
        sleep 0.1
    fi
fi

