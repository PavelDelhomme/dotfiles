services:
  dotfiles-test:
    build:
      # Le contexte est la racine des dotfiles (2 niveaux au-dessus de ce fichier)
      context: ../..
      # Le dockerfile est relatif au contexte
      dockerfile: scripts/test/docker/Dockerfile.test
    image: dotfiles-test:latest
    container_name: dotfiles-test-container
    volumes:
      # Montage en lecture seule pour éviter les modifications
      # Le chemin est relatif au répertoire où docker-compose est exécuté
      - ../../:/root/dotfiles:ro
      # Volume pour les résultats de test (lecture/écriture)
      - dotfiles-test-results:/root/test_results
      # Volume pour la configuration (lecture/écriture)
      - dotfiles-test-config:/root/.config
    environment:
      - DOTFILES_DIR=/root/dotfiles
      - TEST_RESULTS_DIR=/root/test_results
      - HOME=/root
      - TERM=xterm-256color
    stdin_open: true
    tty: true
    # Ne pas redémarrer automatiquement
    restart: "no"
    # Commande par défaut : lancer les tests
    command: /bin/sh -c "cd /root/dotfiles && bash scripts/test/docker/run_tests.sh"

volumes:
  dotfiles-test-results:
    driver: local
  dotfiles-test-config:
    driver: local

